<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Employee Manager</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1>Employee List</h1>
    <h2>Add New Employee</h2>
    <form action="{{ url_for('main.add_employee') }}" method="POST">
        <input type="text" name="first_name" placeholder="First Name" required>
        <input type="text" name="last_name" placeholder="Last Name" required>
        <input type="email" name="email" placeholder="Email" required>
        <input type="text" name="phone" placeholder="Phone">
        <input type="text" name="position" placeholder="Position">
        <button type="submit">Add Employee</button>
    </form>
    <div style="text-align: right; margin-bottom: 10px;">
      <input type="text" id="searchInput" placeholder="Search..." onkeyup="searchEmployees()" />
    </div>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>First Name</th>
          <th>Last Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Position</th>
          <th>Created At</th>
          <th>Updated At</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for emp in employees %}
        <tr>
          <td>{{ emp.employee_id }}</td>
          <td>{{ emp.first_name }}</td>
          <td>{{ emp.last_name }}</td>
          <td>{{ emp.email }}</td>
          <td>{{ emp.phone }}</td>
          <td>{{ emp.position }}</td>
          <td>{{ emp.created_at }}</td>
          <td>{{ emp.updated_at }}</td>
          <td>
            <!-- ปุ่มแก้ไข -->
            <button type="button" class="btn-edit"
              data-id="{{ emp.employee_id }}"
              data-first="{{ emp.first_name }}"
              data-last="{{ emp.last_name }}"
              data-email="{{ emp.email }}"
              data-phone="{{ emp.phone }}"
              data-position="{{ emp.position }}"
              onclick="openEditModal(this)">
              Edit
            </button>

            <!-- ปุ่มลบ -->
            <form action="{{ url_for('main.delete_employee', employee_id=emp.employee_id) }}" method="POST" style="display:inline;" onsubmit="return confirm('คุณแน่ใจหรือไม่ที่จะลบ?');">
              <button type="submit" class="btn-delete">Delete</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- 🔹 Modal Popup -->
    <div id="editModal" class="modal" style="display:none;">
      <div class="modal-content">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h2>Employee edit</h2>
        <form id="editForm" method="POST">
          <input type="text" name="first_name" id="edit_first_name" required>
          <input type="text" name="last_name" id="edit_last_name" required>
          <input type="email" name="email" id="edit_email" required>
          <input type="text" name="phone" id="edit_phone" required>
          <input type="text" name="position" id="edit_position" required>
          <button type="submit">Save</button>
        </form>
      </div>
    </div>

    <script>
      function openEditModal(button) {
        const id = button.getAttribute("data-id");
        const firstName = button.getAttribute("data-first");
        const lastName = button.getAttribute("data-last");
        const email = button.getAttribute("data-email");
        const phone = button.getAttribute("data-phone");
        const position = button.getAttribute("data-position");

        document.getElementById("edit_first_name").value = firstName;
        document.getElementById("edit_last_name").value = lastName;
        document.getElementById("edit_email").value = email;
        document.getElementById("edit_phone").value = phone;
        document.getElementById("edit_position").value = position;
        document.getElementById("editForm").action = "/edit/" + id;

        document.getElementById("editModal").style.display = "block";
      }


      function closeEditModal() {
        document.getElementById("editModal").style.display = "none";
      }
    </script>

    <script>
      async function searchEmployees() {
        let query = document.getElementById("searchInput").value;
        let response = await fetch(`/api/employees/search?q=${query}`);
        let data = await response.json();

        let tbody = document.querySelector("table tbody");
        tbody.innerHTML = "";

        data.forEach(emp => {
          tbody.innerHTML += `
            <tr>
              <td>${emp.id}</td>
              <td>${emp.first_name}</td>
              <td>${emp.last_name}</td>
              <td>${emp.email}</td>
              <td>${emp.phone}</td>
              <td>${emp.position}</td>
              <td>${emp.created_at}</td>
              <td>${emp.updated_at}</td>
              <td>
                <button type="button" class="btn-edit"
                  data-id="${emp.id}"
                  data-first="${emp.first_name}"
                  data-last="${emp.last_name}"
                  data-email="${emp.email}"
                  data-phone="${emp.phone}"
                  data-position="${emp.position}"
                  onclick="openEditModal(this)">Edit</button>

                <form action="/delete/${emp.id}" method="POST" style="display:inline;" onsubmit="return confirm('คุณแน่ใจหรือไม่ที่จะลบ?');">
                  <button type="submit" class="btn-delete">Delete</button>
                </form>
              </td>
            </tr>
          `;
        });
      }
    </script>

</body>
<!-- Modal แก้ไข -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeEditModal()">&times;</span>
    <h2>Employee edit</h2>
    <form id="editForm" method="POST">
      <label>First Name:</label>
      <input type="text" id="edit_first_name" name="first_name" required><br>

      <label>Last Name:</label>
      <input type="text" id="edit_last_name" name="last_name" required><br>

      <label>Email:</label>
      <input type="email" id="edit_email" name="email" required><br>

      <label>Phone:</label>
      <input type="text" id="edit_phone" name="phone" required><br>

      <label>Position:</label>
      <input type="text" id="edit_position" name="position" required><br>

      <button type="submit" class="btn-edit">Save</button>
      <button type="button" onclick="closeEditModal()">Cancel</button>
    </form>
  </div>
</div>
</html>
